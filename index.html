<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1">
    <title>Glass Minesweeper v2</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* --- 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ --- */
        :root {
            --bg-color: #f2f2f7;
            --text-color: #000000;
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.6);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            --cell-bg: rgba(255, 255, 255, 0.6);
            --cell-revealed: rgba(220, 220, 220, 0.5);
            --accent: #007aff;
            --accent-fade: rgba(0, 122, 255, 0.15);
            --danger: #ff3b30;
            --success: #34c759;
            --toggle-bg: #e9e9ea;
            --toggle-circle: #ffffff;
            --icon-color: #3a3a3c;
            --font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --anim-curve: cubic-bezier(0.25, 1, 0.5, 1);
        }

        [data-theme="dark"] {
            --bg-color: #000000;
            --text-color: #ffffff;
            --glass-bg: rgba(30, 30, 30, 0.75);
            --glass-border: rgba(255, 255, 255, 0.15);
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            --cell-bg: rgba(255, 255, 255, 0.12);
            --cell-revealed: rgba(0, 0, 0, 0.3);
            --toggle-bg: #2c2c2e;
            --toggle-circle: #636366;
            --icon-color: #aeaeb2;
            --accent: #0a84ff;
            --accent-fade: rgba(10, 132, 255, 0.2);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow: hidden; /* –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
            transition: background-color 0.4s ease;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- SVG Icons Utility --- */
        .icon {
            width: 24px;
            height: 24px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .icon-sm { width: 18px; height: 18px; }
        .icon-lg { width: 32px; height: 32px; }

        /* --- Header & Toggle --- */
        .header {
            width: 90%;
            max-width: 400px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            margin-bottom: 15px;
            z-index: 10;
        }

        .title {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        /* –ù–æ–≤—ã–π –°–ª–∞–π–¥–µ—Ä */
        .theme-switch {
            position: relative;
            width: 68px;
            height: 36px;
            background: var(--toggle-bg);
            border-radius: 20px;
            cursor: pointer;
            padding: 2px;
            box-sizing: border-box;
            transition: background 0.3s ease;
        }

        .theme-icons {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 8px;
            box-sizing: border-box;
            pointer-events: none;
            color: var(--icon-color);
        }

        .switch-circle {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 30px;
            height: 30px;
            background: var(--toggle-circle);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            transition: transform 0.4s var(--anim-curve);
            z-index: 2;
        }

        [data-theme="dark"] .switch-circle {
            transform: translateX(32px);
            background: #ffffff; /* –ö—Ä—É–∂–æ–∫ –≤—Å–µ–≥–¥–∞ –±–µ–ª—ã–π –∏–ª–∏ —Å–≤–µ—Ç–ª—ã–π –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ */
        }

        /* --- Stats Bar --- */
        .stats-container {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            background: var(--glass-bg);
            padding: 8px 20px;
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: var(--shadow);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            font-size: 17px;
            font-variant-numeric: tabular-nums;
        }

        /* --- Game Grid --- */
        .game-wrapper {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* –ß—Ç–æ–±—ã –Ω–µ –ø—Ä—ã–≥–∞–ª–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
            overflow: auto;
            width: 100%;
            padding-bottom: 100px; /* –ú–µ—Å—Ç–æ –ø–æ–¥ –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é */
        }

        .grid {
            display: grid;
            gap: 5px;
            padding: 10px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }

        .cell {
            width: 38px;
            height: 38px;
            background: var(--cell-bg);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            position: relative;
            transition: transform 0.1s, background 0.2s;
        }

        .cell:active { transform: scale(0.9); }
        .cell.revealed { background: var(--cell-revealed); cursor: default; }
        
        .cell.flagged { color: var(--danger); }
        .cell.flagged svg { fill: var(--danger); stroke: var(--danger); }

        /* –¶–≤–µ—Ç–∞ —Ü–∏—Ñ—Ä */
        .c-1 { color: #007aff; }
        .c-2 { color: #34c759; }
        .c-3 { color: #ff3b30; }
        .c-4 { color: #5856d6; }
        .c-5 { color: #ff9500; }
        .c-6 { color: #00c7be; }
        .c-7 { color: #323232; }
        .c-8 { color: #8e8e93; }

        .cell.mine {
            background: rgba(255, 59, 48, 0.4);
            border: 1px solid rgba(255, 59, 48, 0.5);
        }

        /* --- Bottom Controls (Switchers) --- */
        .bottom-controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            padding: 6px;
            border-radius: 50px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 100;
            gap: 5px;
        }

        .control-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 120px;
            height: 44px;
            border-radius: 40px;
            border: none;
            background: transparent;
            color: var(--text-color);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s var(--anim-curve);
        }

        .control-btn.active {
            background: var(--accent);
            color: #ffffff;
            box-shadow: 0 4px 15px var(--accent-fade);
        }

        /* --- Modals (Popups) --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: var(--bg-color); /* –°–ø–ª–æ—à–Ω–æ–π —Ñ–æ–Ω –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ */
            width: 85%;
            max-width: 320px;
            padding: 30px 25px;
            border-radius: 28px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            transform: scale(0.9) translateY(20px);
            transition: transform 0.4s var(--anim-curve);
            border: 1px solid var(--glass-border);
            position: relative;
            overflow: hidden;
        }

        .modal-overlay.visible .modal {
            transform: scale(1) translateY(0);
        }

        .modal h2 { margin: 0 0 15px 0; font-size: 24px; }
        .modal p { color: #8e8e93; font-size: 15px; margin-bottom: 25px; line-height: 1.5; }
        
        .btn-primary {
            background: var(--accent);
            color: white;
            border: none;
            padding: 14px 0;
            width: 100%;
            border-radius: 14px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .difficulty-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .diff-btn {
            background: var(--toggle-bg);
            border: 2px solid transparent;
            padding: 12px;
            border-radius: 12px;
            font-weight: 500;
            color: var(--text-color);
            cursor: pointer;
        }
        
        .diff-btn.selected {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-fade);
        }

    </style>
</head>
<body>

    <div class="header">
        <div class="title">Saper</div>
        <div class="theme-switch" id="themeToggle">
            <div class="theme-icons">
                <svg class="icon icon-sm" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="5"></circle>
                    <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
                </svg>
                <svg class="icon icon-sm" viewBox="0 0 24 24">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </div>
            <div class="switch-circle"></div>
        </div>
    </div>

    <div class="stats-container">
        <div class="stat-item">
            <svg class="icon" viewBox="0 0 24 24" style="color: var(--danger);">
                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                <line x1="4" y1="22" x2="4" y2="15"></line>
            </svg>
            <span id="flagsLeft">10</span>
        </div>
        <div class="stat-item">
            <svg class="icon" viewBox="0 0 24 24" style="color: var(--text-color);">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <span id="timer">000</span>
        </div>
    </div>

    <div class="game-wrapper">
        <div class="grid" id="grid"></div>
    </div>

    <div class="bottom-controls">
        <button class="control-btn active" id="btnDig" onclick="setMode('dig')">
            <svg class="icon icon-sm" viewBox="0 0 24 24">
                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
            </svg>
            –ö–æ–ø–∞—Ç—å
        </button>
        <button class="control-btn" id="btnFlag" onclick="setMode('flag')">
            <svg class="icon icon-sm" viewBox="0 0 24 24">
                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                <line x1="4" y1="22" x2="4" y2="15"></line>
            </svg>
            –§–ª–∞–≥
        </button>
    </div>

    <div class="modal-overlay visible" id="startModal">
        <div class="modal">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã</h2>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä –ø–æ–ª—è. <br>–ò—Å–ø–æ–ª—å–∑—É–π –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é, —á—Ç–æ–±—ã –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É —Ä–∞—Å–∫–æ–ø–∫–æ–π –∏ —Ñ–ª–∞–≥–∞–º–∏.</p>
            
            <div class="difficulty-grid">
                <div class="diff-btn selected" onclick="selectDiff(8, 8, 10, this)">8x8</div>
                <div class="diff-btn" onclick="selectDiff(10, 8, 15, this)">10x8</div>
                <div class="diff-btn" onclick="selectDiff(10, 10, 20, this)">10x10</div>
                <div class="diff-btn" onclick="selectDiff(15, 12, 30, this)">15x12</div>
            </div>

            <button class="btn-primary" onclick="startGame()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
        </div>
    </div>

    <div class="modal-overlay" id="resultModal">
        <div class="modal">
            <h2 id="resultTitle">–ü–æ–±–µ–¥–∞! üéâ</h2>
            <p id="resultText">–¢—ã —Å–ø—Ä–∞–≤–∏–ª—Å—è –∑–∞ 45 —Å–µ–∫!</p>
            <button class="btn-primary" onclick="showStartModal()">–ú–µ–Ω—é</button>
        </div>
    </div>

    <script>
        // --- –õ–æ–≥–∏–∫–∞ –ò–≥—Ä—ã ---
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Elements
        const gridElement = document.getElementById('grid');
        const flagsElement = document.getElementById('flagsLeft');
        const timerElement = document.getElementById('timer');
        const themeToggle = document.getElementById('themeToggle');
        
        // Modals
        const startModal = document.getElementById('startModal');
        const resultModal = document.getElementById('resultModal');

        // State
        let ROWS = 8;
        let COLS = 8;
        let MINES = 10;
        let currentMode = 'dig'; // 'dig' or 'flag'
        
        let grid = [];
        let gameOver = false;
        let flags = 0;
        let timer = 0;
        let timerInterval = null;
        let firstClick = true;

        // --- Theme Switch ---
        let isDark = false;
        if(tg.colorScheme === 'dark') isDark = true;
        
        function updateTheme() {
            document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
        }
        updateTheme(); // Init

        themeToggle.addEventListener('click', () => {
            isDark = !isDark;
            updateTheme();
            if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
        });

        // --- Game Setup ---
        let selectedRows = 8, selectedCols = 8, selectedMines = 10;

        function selectDiff(r, c, m, btn) {
            selectedRows = r; selectedCols = c; selectedMines = m;
            document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        }

        function showStartModal() {
            resultModal.classList.remove('visible');
            startModal.classList.add('visible');
        }

        function startGame() {
            ROWS = selectedRows;
            COLS = selectedCols;
            MINES = selectedMines;
            startModal.classList.remove('visible');
            initGame();
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btnDig').classList.toggle('active', mode === 'dig');
            document.getElementById('btnFlag').classList.toggle('active', mode === 'flag');
            if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
        }

        function initGame() {
            clearInterval(timerInterval);
            timer = 0;
            timerElement.innerText = '000';
            flags = MINES;
            flagsElement.innerText = flags;
            gameOver = false;
            firstClick = true;
            grid = [];
            gridElement.innerHTML = '';
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CSS grid
            gridElement.style.gridTemplateColumns = `repeat(${COLS}, 38px)`;

            // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–µ
            for (let r = 0; r < ROWS; r++) {
                const row = [];
                for (let c = 0; c < COLS; c++) {
                    const cell = {
                        r, c,
                        isMine: false,
                        revealed: false,
                        flagged: false,
                        neighborMines: 0,
                        element: document.createElement('div')
                    };
                    cell.element.classList.add('cell');
                    
                    // Main Click
                    cell.element.addEventListener('click', () => handleInput(cell));
                    
                    gridElement.appendChild(cell.element);
                    row.push(cell);
                }
                grid.push(row);
            }
        }

        // --- Core Logic ---
        function handleInput(cell) {
            if (gameOver || cell.revealed) return;

            if (currentMode === 'flag') {
                toggleFlag(cell);
            } else {
                if (cell.flagged) return; // –ù–µ –∫–æ–ø–∞–µ–º —Ñ–ª–∞–≥
                if (firstClick) {
                    firstClick = false;
                    placeMines(cell.r, cell.c);
                    startTimer();
                }
                revealCell(cell);
            }
        }

        function toggleFlag(cell) {
            if (cell.revealed) return;
            if (!cell.flagged && flags > 0) {
                cell.flagged = true;
                cell.element.classList.add('flagged');
                cell.element.innerHTML = `<svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg>`;
                flags--;
                if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
            } else if (cell.flagged) {
                cell.flagged = false;
                cell.element.classList.remove('flagged');
                cell.element.innerHTML = '';
                flags++;
                if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
            }
            flagsElement.innerText = flags;
        }

        function revealCell(cell) {
            if (cell.isMine) {
                triggerGameOver(false);
                cell.element.style.background = '#ff3b30';
                return;
            }

            cell.revealed = true;
            cell.element.classList.add('revealed');
            
            if (cell.neighborMines > 0) {
                cell.element.innerText = cell.neighborMines;
                cell.element.classList.add(`c-${cell.neighborMines}`);
            } else {
                // Flood Fill
                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        const nr = cell.r + dr;
                        const nc = cell.c + dc;
                        if (nr >= 0 && nr < ROWS && nc >= 0 && nc < COLS) {
                            const neighbor = grid[nr][nc];
                            if (!neighbor.revealed && !neighbor.flagged) {
                                revealCell(neighbor);
                            }
                        }
                    }
                }
            }
            
            if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
            checkWin();
        }

        function placeMines(exR, exC) {
            let placed = 0;
            while (placed < MINES) {
                const r = Math.floor(Math.random() * ROWS);
                const c = Math.floor(Math.random() * COLS);
                if (!grid[r][c].isMine && (r !== exR || c !== exC)) {
                    grid[r][c].isMine = true;
                    placed++;
                }
            }
            // –°—á–∏—Ç–∞–µ–º —Ü–∏—Ñ—Ä—ã
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    if (grid[r][c].isMine) continue;
                    let count = 0;
                    for (let dr = -1; dr <= 1; dr++) {
                        for (let dc = -1; dc <= 1; dc++) {
                            const nr = r + dr, nc = c + dc;
                            if (nr>=0 && nr<ROWS && nc>=0 && nc<COLS && grid[nr][nc].isMine) count++;
                        }
                    }
                    grid[r][c].neighborMines = count;
                }
            }
        }

        function checkWin() {
            let revealedCount = 0;
            grid.forEach(r => r.forEach(c => { if(c.revealed) revealedCount++; }));
            if (revealedCount === (ROWS * COLS - MINES)) {
                triggerGameOver(true);
            }
        }

        function triggerGameOver(win) {
            gameOver = true;
            clearInterval(timerInterval);
            
            if (win) {
                fireConfetti();
                document.getElementById('resultTitle').innerText = "–ü–æ–±–µ–¥–∞! üéâ";
                document.getElementById('resultText').innerText = `–ü–æ–ª–µ —Ä–∞–∑–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–æ –∑–∞ ${timer} —Å–µ–∫.`;
                if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            } else {
                document.getElementById('resultTitle').innerText = "–ë—É–º! üí•";
                document.getElementById('resultText').innerText = "–ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.";
                if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
                
                // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –º–∏–Ω—ã
                grid.forEach(r => r.forEach(c => {
                    if (c.isMine) {
                        c.element.classList.add('mine');
                        c.element.innerHTML = `<svg class="icon icon-sm" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#000" opacity="0.5"></circle></svg>`; 
                    }
                }));
            }
            
            setTimeout(() => {
                resultModal.classList.add('visible');
            }, 1000);
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timer++;
                timerElement.innerText = timer.toString().padStart(3, '0');
            }, 1000);
        }

        // --- Confetti Effect ---
        function fireConfetti() {
            const duration = 3000;
            const end = Date.now() + duration;

            (function frame() {
                confetti({
                    particleCount: 5,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0, y: 0.8 }, // –õ–µ–≤—ã–π —É–≥–æ–ª
                    colors: ['#ff3b30', '#007aff', '#34c759', '#ff9500']
                });
                confetti({
                    particleCount: 5,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1, y: 0.8 }, // –ü—Ä–∞–≤—ã–π —É–≥–æ–ª
                    colors: ['#ff3b30', '#007aff', '#34c759', '#ff9500']
                });

                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            }());
        }

    </script>
</body>
</html>